<!DOCTYPE html>
<html lang="zh-cn" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="domac" />
	
	
	
	<title>Kubernetes CRD 开发实践 ｜ domac的菜园子</title>
	
    
    
    <meta name="description" content="背景 Kubernetes的最大亮点之一必定是它的声明式API设计，所谓的声明式就是告诉kubernetes你要什么，而不是告诉它怎么做命令。我们日常使用kubernetes做编排工作的时候，经常会接触 Deployment、Service、Pod 等资源对象，我们可以很灵活地创建其定义配置，然后执行 kubectl apply 命令，kubernetes总能为我们创建相关资源对象并完成资源的注册，进而执行资源所负责的功能。
但是我们有没想过，日常业务开发过程中，虽然常规的资源基本满足需求，但是这些常规的资源大多仅仅是代表相对底层、通用的概念的对象， 某些情况下我们总是想根据业务定制我们的资源类型，并且利用kubernetes的声明式API，对资源的增删改查进行监听并作出具体的业务功能。随着Kubernetes生态系统的持续发展，越来越多高层次的对象将会不断涌现，比起目前使用的对象，新对象将更加专业化。
有了自定义资源定义API，开发者将不需要逐一进行 Deployment、Service、ConfigMap 等步骤，而是创建并关联一些用于表述整个应用程序或者软件服务的对象。除此，我们能使用自定义的高阶对象，并在这些高阶对象的基础上创建底层对象。例如：我们想要一个Backup资源，我们创建它的对象时，就希望通过spec的定义进行日常的备份操作声明，当提交给k8s集群的时候，相关的Deployment、Service资源会被自动创建，很大程度让业务扩展性加大。
" />
    

    
    
    <meta name="keywords" content="go, linux, domac, kubernetes, k8s, gopher" />
    

	
    
    <link rel="shortcut icon" href="https://domac.github.io/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://domac.github.io/css/normalize.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.0/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://domac.github.io/css/zozo.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://domac.github.io/css/highlight.css" />

    
    
</head>

<body>
    <div class="main animate__animated animate__fadeInDown">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul>
            
            <li>
                <a href="/">主页</a>
            </li>
            
            <li>
                <a href="/posts/">文章</a>
            </li>
            
            <li>
                <a href="/tags/">标签</a>
            </li>
            
            <li>
                <a href="/about/">关于我</a>
            </li>
            
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://domac.github.io/">
                    <span>domac的菜园子</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title"></p>
            <div class="my_socials">
                
                
                <a href="https://github.com/domac" title="github" target="_blank"><i class="ri-github-fill"></i></a>
                
                
                
                <a href="https://twitter.com/domacHQ" title="twitter" target="_blank"><i class="ri-twitter-fill"></i></a>
                
                
                
                <a href="https://weibo.com/328080453" title="weibo" target="_blank"><i class="ri-weibo-fill"></i></a>
                
                
                <a href="https://domac.github.io/index.xml" type="application/rss+xml" title="rss" target="_blank"><i
                        class="ri-rss-fill"></i></a>
            </div>
        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2><a href='/posts/k8s-crd-develop/'>Kubernetes CRD 开发实践</a></h2>
                        <span class="date">2020.03.08</span>
                    </div>
                    <div class="post_content markdown"><h2 id="背景">背景</h2>
<p>Kubernetes的最大亮点之一必定是它的声明式API设计，所谓的声明式就是告诉kubernetes你要什么，而不是告诉它怎么做命令。我们日常使用kubernetes做编排工作的时候，经常会接触 <code>Deployment</code>、<code>Service</code>、<code>Pod</code> 等资源对象，我们可以很灵活地创建其定义配置，然后执行 kubectl apply 命令，kubernetes总能为我们创建相关资源对象并完成资源的注册，进而执行资源所负责的功能。</p>
<p>但是我们有没想过，日常业务开发过程中，虽然常规的资源基本满足需求，但是这些常规的资源大多仅仅是代表相对底层、通用的概念的对象， 某些情况下我们总是想根据业务定制我们的资源类型，并且利用kubernetes的声明式API，对资源的<code>增删改查</code>进行监听并作出具体的业务功能。随着Kubernetes生态系统的持续发展，越来越多高层次的对象将会不断涌现，比起目前使用的对象，新对象将更加专业化。</p>
<p>有了自定义资源定义API，开发者将不需要逐一进行 Deployment、Service、ConfigMap 等步骤，而是创建并关联一些用于表述整个应用程序或者软件服务的对象。除此，我们能使用自定义的高阶对象，并在这些高阶对象的基础上创建底层对象。例如：我们想要一个Backup资源，我们创建它的对象时，就希望通过spec的定义进行日常的备份操作声明，当提交给k8s集群的时候，相关的Deployment、Service资源会被自动创建，很大程度让业务扩展性加大。</p>
<p>在 <code>Kubernetes1.7</code> 之前，要实现类似的自定义资源，需要通过 <code>TPR（ThirdPartyResource ）</code> 对象方式定义自定义资源，但因为这种方式十分复杂，一度并不被人重视。到了 <code>Kubernetes1.8</code> 版本，TPR开始被停用，被官方推荐的 <code>CRD（CustomResourceDefinitions）所取代</code>。</p>
<p><code>CRD</code>，称之为自定义资源定义，本质上，它的表现形式是一段声明，用于定义用户定义的资源对象罢了。单单通过它还不能产生任何收益，因为开发者还要针对CRD定义提供关联的CRD对象CRD控制器（CRD Controller）。CRD控制器通常可以通过Golang进行开发，只需要遵循Kubernetes的控制器开发规范，并基于client-go进行调用，并实现 Informer、ResourceEventHandler、Workqueue等组件逻辑即可。听起来感觉很复杂的样子，不过其实真正开发的时候，并不困难，因为大部分繁琐的代码逻辑都能通过k8s的code generator代码生成出来。关于如何进行CRD控制器的开发，下面我们会通过一个例子慢慢地深入，希望通过实践来理解CRD的原理。</p>
<h3 id="crd定义范例">CRD定义范例</h3>
<p>与其他资源对象一样，对CRD的定义也使用YAML配置进行声明。下面先来看下本文的Demo例子的CRD定义</p>
<p>本文的 crddemo 源码为：<a href="https://github.com/domac/crddemo">https://github.com/domac/crddemo</a></p>
<p><em>mydemo.yaml</em></p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>apiextensions.k8s.io/v1beta1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>CustomResourceDefinition<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>mydemos.crddemo.k8s.io<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>group<span class="p">:</span><span class="w"> </span>crddemo.k8s.io<span class="w">
</span><span class="w">  </span>version<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w">  </span>names<span class="p">:</span><span class="w">
</span><span class="w">    </span>kind<span class="p">:</span><span class="w"> </span>Mydemo<span class="w">
</span><span class="w">    </span>plural<span class="p">:</span><span class="w"> </span>mydemos<span class="w">
</span><span class="w">  </span>scope<span class="p">:</span><span class="w"> </span>Namespaced<span class="w">
</span></code></pre></div><p>CRD定义中的关键字段如下：</p>
<p><img src="/2020/202003081.png" alt="api url"></p>
<ul>
<li>
<p>group：设置API所属的组，将其映射为API URL中的 “/apis/” 下一级目录。它是逻辑上相关的Kinds集合</p>
</li>
<li>
<p>scope：该API的生效范围，可选项为Namespaced和Cluster。</p>
</li>
<li>
<p>version：每个 Group 可以存在多个版本。例如，v1alpha1，然后升为 v1beta1，最后稳定为 v1 版本。</p>
</li>
<li>
<p>names：CRD的名称，包括单数、复数、kind、所属组等名称定义</p>
</li>
</ul>
<p>在这个 CRD 中，我指定了 <code>group: crddemo.k8s.io</code> , <code>version: v1</code> 这样的 API 信息，也指定了这个 CR 的资源类型叫作 Mydemo，复数（plural）是 mydemos。</p>
<p>我们先别着急使用kubectl create创建资源定义，我们接下来要做的是再基于这个CRD的定义创建相应的具体自定义对象</p>
<p><em>example-mydemo.yaml</em></p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>crddemo.k8s.io/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Mydemo<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>example-mydemo<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>ip<span class="p">:</span><span class="w"> </span><span class="s2">&#34;127.0.0.1&#34;</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></code></pre></div><p>这个资源对象跟定义pod差不多，它的主要信息都是来源上面的定义，Kind是<code>Mydemo</code>，版本是<code>v1</code>，资源组是<code>crddemo.k8s.io</code></p>
<p>除了这些设置，还需要在spec端设置相应的参数，一般是开发者自定义定制的，在这里，我定制了两个属性：<code>ip</code>和<code>port</code>。所以整个对象我要告诉k8s，我期待监听处理一个叫example-mydemo的程序，它的地址是127.0.0.1，端口是8080。
当然，这里只是一个demo，没有什么严格的属性约束，开发者还是根据自己的业务需要自行定义吧。为了不影响本文的介绍，姑且认为这两个属性是非常重要的。</p>
<p>到这里为止，相对轻松的工作已经完成，我们已经完成CRD的“设计图”工作，下面我们开始动手构建这个CRD控制器的编码工作了。</p>
<h3 id="crd-控制器原理">CRD 控制器原理</h3>
<p>在正式编码之前，我们先理解一下自定义控制器的工作原理，如下图</p>
<p><img src="/2020/2020030803.png" alt="crd arch"></p>
<p>CRD控制器的工作流，可分为监听、同步、触发三个步骤：</p>
<p>一、Controller 首先会通过Informer （所谓的 Informer，就是一个自带缓存和索引机制），从K8ss的API Server中获取它所关心的对象，举个例子，也就是我编写的Controller获取的应该是Mydemo对象。值得注意的是Informer在构建之前，会使用我们生成的client（下面编码阶段会提到）,再透过Reflector的ListAndWatch机制跟API Server建立连接，不断地监听 Mydemo对象实例的变化。在 ListAndWatch 机制下，一旦 APIServer 端有新的 Mydemo 实例被创建、删除或者更新，Reflector 都会收到“事件通知”。该事件及它对应的 API 对象会被放进一个 Delta FIFO Queue中。</p>
<p>二、Local Store 此时完成同步缓存操作</p>
<p>三、Informer 根据这些事件的类型，触发我们编写并注册号的ResourceEventHandler，完成业务动作的触发。</p>
<p>上面图中的 Control Loop 实际上可以通过code-generator生成,下面也会提到。总之Control Loop中我们只关心如何拿到“实际状态”，并与“期待状态”对比，从而具体的差异处理逻辑，只需要开发者自行编写即可。</p>
<h3 id="crd-开发过程">CRD 开发过程</h3>
<p>下面会通过一个简单的例子，开始我们的CRD代码的编写， <a href="https://github.com/domac/crddemo">完整代码: https://github.com/domac/crddemo</a></p>
<p>自定义资源代码编写</p>
<p>首先，kubernetes涉及的代码生成对项目目录结构是有要求的，所以我们先创建一个结构如下的项目</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">├── controller.go
├── crd
│   └── mydemo.yaml
├── example
│   └── example-mydemo.yaml
├── main.go
└── pkg
    └── apis
        └── crddemo
            ├── register.go
            └── v1
                ├── doc.go
                ├── register.go
                ├── types.go
</code></pre></div><p>可见关键部分的pkg目录就是API组的URL结构, 如下图</p>
<p><img src="/2020/202003082.png" alt="path2"></p>
<p>v1 下面的 types.go 文件里，则定义了 Mydemo 对象的完整描述。</p>
<p>1、我们首先开看 <code>pkg/apis/crddemo/register.go</code>，这个文件主要用来存放全局变量，如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">crddemo</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">GroupName</span> <span class="p">=</span> <span class="s">&#34;crddemo.k8s.io&#34;</span>
    <span class="nx">Version</span>   <span class="p">=</span> <span class="s">&#34;v1&#34;</span>
<span class="p">)</span>
</code></pre></div><p>2、<em>pkg/apis/crddemo/v1下的doc.go</em> 也是比较简单的：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// +k8s:deepcopy-gen=package
</span><span class="c1"></span><span class="c1">// +groupName=crddemo.k8s.io
</span><span class="c1"></span><span class="kn">package</span> <span class="nx">v1</span>
</code></pre></div><p>在这个文件中，你会看到 +k8s:deepcopy-gen=package 和  +groupName=crddemo.k8s.io，这就是 Kubernetes 进行代码生成要用的 Annotation 风格的注释。</p>
<ul>
<li><code>+k8s:deepcopy-gen=package</code> 意思是，请为整个 v1 包里的所有类型定义自动生成 DeepCopy 方法；</li>
<li><code>+groupName=crddemo.k8s.io</code>，则定义了这个包对应的crddemo  API 组的名字。</li>
</ul>
<p>可以看到，这些定义在 doc.go 文件的注释，起到的是全局的代码生成控制的作用，所以也被称为 Global Tags。</p>
<p>3、<em>pkg/apis/crddemo/types.go</em> 的作用就是定义一个 Mydemo 类型到底有哪些字段（比如，spec 字段里的内容）。这个文件的主要内容如下所示：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">v1</span>


<span class="kn">import</span> <span class="p">(</span>
    <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
<span class="p">)</span>


<span class="c1">// +genclient
</span><span class="c1"></span><span class="c1">// +genclient:noStatus
</span><span class="c1"></span><span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span class="c1"></span>

<span class="c1">// Mydemo 描述一个 Mydemo的资源字段
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Mydemo</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`</span><span class="s">json:&#34;,inline&#34;</span><span class="s">`</span>

    <span class="nx">metav1</span><span class="p">.</span><span class="nx">ObjectMeta</span> <span class="s">`</span><span class="s">json:&#34;metadata,omitempty&#34;</span><span class="s">`</span>

    <span class="nx">Spec</span> <span class="nx">MydemoSpec</span> <span class="s">`</span><span class="s">json:&#34;spec&#34;</span><span class="s">`</span>
<span class="p">}</span>

<span class="c1">//MydemoSpec 为 Mydemo的资源的spec属性的字段
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">MydemoSpec</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Ip</span>   <span class="kt">string</span> <span class="s">`</span><span class="s">json:&#34;ip&#34;</span><span class="s">`</span>
    <span class="nx">Port</span> <span class="kt">int</span>    <span class="s">`</span><span class="s">json:&#34;port&#34;</span><span class="s">`</span>
<span class="p">}</span>


<span class="c1">// +k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object
</span><span class="c1"></span>
<span class="c1">//复数形式
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">MydemoList</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">metav1</span><span class="p">.</span><span class="nx">TypeMeta</span> <span class="s">`</span><span class="s">json:&#34;,inline&#34;</span><span class="s">`</span>
    <span class="nx">metav1</span><span class="p">.</span><span class="nx">ListMeta</span> <span class="s">`</span><span class="s">json:&#34;metadata&#34;</span><span class="s">`</span>

    <span class="nx">Items</span> <span class="p">[</span><span class="p">]</span><span class="nx">Mydemo</span> <span class="s">`</span><span class="s">json:&#34;items&#34;</span><span class="s">`</span>
<span class="p">}</span>
</code></pre></div><p>上面的代码，可以开的我们的Mydemo可续定义方法跟k8s对象一样，都包含了TypeMeta和ObjectMeta字段，而其中比较重要的是 Spec 字段，就是需要我们自己定义的部分：定义了 Ip 和 Port 两个字段。</p>
<p>此外，除了定义 Mydemo  类型，你还需要定义一个 MydemoList 类型，用来描述一组 Mydemo 对象应该包括哪些字段。之所以需要这样一个类型，是因为在 Kubernetes 中，获取所有某对象的 List() 方法，返回值都是List 类型，而不是某类型的数组。所以代码上一定要做区分</p>
<p>关于上面代码的几个重要注解，下面说明一下：</p>
<ul>
<li>
<p><code>+genclient</code> 这段注解的意思是：请为下面资源类型生成对应的 Client 代码。</p>
</li>
<li>
<p><code>+genclient:noStatus</code> 的意思是：这个 API 资源类型定义里，没有 Status 字段，因为Mydemo才是主类型，所以 +genclient 要写在Mydemo之上，不用写在MydemoList之上，这时要细心注意的。</p>
</li>
<li>
<p><code>+k8s:deepcopy-gen:interfaces=k8s.io/apimachinery/pkg/runtime.Object</code> 的意思是，请在生成 DeepCopy 的时候，实现 Kubernetes 提供的 runtime.Object 接口。否则，在某些版本的 Kubernetes 里，你的这个类型定义会出现编译错误。</p>
</li>
</ul>
<p>4、<em>pkg/apis/crddemo/register.go</em> 作用就是注册一个类型（Type）给 APIServer。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">v1</span>


<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;github.com/domac/crddemo/pkg/apis/crddemo&#34;</span>
    <span class="nx">metav1</span> <span class="s">&#34;k8s.io/apimachinery/pkg/apis/meta/v1&#34;</span>
    <span class="s">&#34;k8s.io/apimachinery/pkg/runtime&#34;</span>
    <span class="s">&#34;k8s.io/apimachinery/pkg/runtime/schema&#34;</span>
<span class="p">)</span>


<span class="kd">var</span> <span class="nx">SchemeGroupVersion</span> <span class="p">=</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupVersion</span><span class="p">{</span>
    <span class="nx">Group</span><span class="p">:</span>   <span class="nx">crddemo</span><span class="p">.</span><span class="nx">GroupName</span><span class="p">,</span>
    <span class="nx">Version</span><span class="p">:</span> <span class="nx">crddemo</span><span class="p">.</span><span class="nx">Version</span><span class="p">,</span>
<span class="p">}</span>


<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">SchemeBuilder</span> <span class="p">=</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">NewSchemeBuilder</span><span class="p">(</span><span class="nx">addKnownTypes</span><span class="p">)</span>
    <span class="nx">AddToScheme</span>   <span class="p">=</span> <span class="nx">SchemeBuilder</span><span class="p">.</span><span class="nx">AddToScheme</span>
<span class="p">)</span>


<span class="kd">func</span> <span class="nf">Resource</span><span class="p">(</span><span class="nx">resource</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupResource</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nf">WithResource</span><span class="p">(</span><span class="nx">resource</span><span class="p">)</span><span class="p">.</span><span class="nf">GroupResource</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nf">Kind</span><span class="p">(</span><span class="nx">kind</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">GroupKind</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">SchemeGroupVersion</span><span class="p">.</span><span class="nf">WithKind</span><span class="p">(</span><span class="nx">kind</span><span class="p">)</span><span class="p">.</span><span class="nf">GroupKind</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1">//Mydemo 资源类型在服务器端的注册的工作，APIServer 会自动帮我们完成
</span><span class="c1"></span><span class="c1">//但与之对应的，我们还需要让客户端也能知道 Mydemo 资源类型的定义
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">addKnownTypes</span><span class="p">(</span><span class="nx">scheme</span> <span class="o">*</span><span class="nx">runtime</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">scheme</span><span class="p">.</span><span class="nf">AddKnownTypes</span><span class="p">(</span>
        <span class="nx">SchemeGroupVersion</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="nx">Mydemo</span><span class="p">{</span><span class="p">}</span><span class="p">,</span>
        <span class="o">&amp;</span><span class="nx">MydemoList</span><span class="p">{</span><span class="p">}</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">// register the type in the scheme
</span><span class="c1"></span>    <span class="nx">metav1</span><span class="p">.</span><span class="nf">AddToGroupVersion</span><span class="p">(</span><span class="nx">scheme</span><span class="p">,</span> <span class="nx">SchemeGroupVersion</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>有了 <code>addKnownTypes</code> 这个方法，Kubernetes 就能够在后面生成客户端的时候，知道Mydemo 以及MydemoList 类型的定义了。</p>
<p>好了，到这里为止，我们有关定义的代码已经写好了，正如controller原理图所示，接下来我们需要通过kubernetes提供的代码生成工具，为上面的Mydemo资源类型生成clientset、informer 和 lister。</p>
<p>关于如何使用代码生成，这里我已经编写了一个脚步，只需只需本脚步即可</p>
<h3 id="代码生成">代码生成</h3>
<p>具体可以调用我提供的shll脚本：<code>code-gen.sh</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
<span class="nb">set</span> -x

<span class="nv">ROOT_PACKAGE</span><span class="o">=</span><span class="s2">&#34;github.com/domac/crddemo&#34;</span>
<span class="nv">CUSTOM_RESOURCE_NAME</span><span class="o">=</span><span class="s2">&#34;crddemo&#34;</span>
<span class="nv">CUSTOM_RESOURCE_VERSION</span><span class="o">=</span><span class="s2">&#34;v1&#34;</span>
<span class="nv">GO111MODULE</span><span class="o">=</span>off

<span class="c1"># 安装k8s.io/code-generator</span>
<span class="o">[</span><span class="o">[</span> -d <span class="nv">$GOPATH</span>/src/k8s.io/code-generator <span class="o">]</span><span class="o">]</span> <span class="o">||</span> go get -u k8s.io/code-generator/...

<span class="c1"># 执行代码自动生成，其中pkg/client是生成目标目录，pkg/apis是类型定义目录</span>
<span class="nb">cd</span> <span class="nv">$GOPATH</span>/src/k8s.io/code-generator <span class="o">&amp;&amp;</span> ./generate-groups.sh all <span class="s2">&#34;</span><span class="nv">$ROOT_PACKAGE</span><span class="s2">/pkg/client</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$ROOT_PACKAGE</span><span class="s2">/pkg/apis</span><span class="s2">&#34;</span> <span class="s2">&#34;</span><span class="nv">$CUSTOM_RESOURCE_NAME</span><span class="s2">:</span><span class="nv">$CUSTOM_RESOURCE_VERSION</span><span class="s2">&#34;</span>
</code></pre></div><p>当只需代码生成脚步后，可以发现我们的代码工作目录也发送了变化，多出了一个<code>client目录</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">client
├── clientset
│   └── versioned
│       ├── clientset.go
│       ├── doc.go
│       ├── fake
│       │   ├── clientset_generated.go
│       │   ├── doc.go
│       │   └── register.go
│       ├── scheme
│       │   ├── doc.go
│       │   └── register.go
│       └── typed
│           └── crddemo
│               └── v1
│                   ├── crddemo_client.go
│                   ├── doc.go
│                   ├── fake
│                   │   ├── doc.go
│                   │   ├── fake_crddemo_client.go
│                   │   └── fake_mydemo.go
│                   ├── generated_expansion.go
│                   └── mydemo.go
├── informers
│   └── externalversions
│       ├── crddemo
│       │   ├── interface.go
│       │   └── v1
│       │       ├── interface.go
│       │       └── mydemo.go
│       ├── factory.go
│       ├── generic.go
│       └── internalinterfaces
│           └── factory_interfaces.go
└── listers
    └── crddemo
        └── v1
            ├── expansion_generated.go
            └── mydemo.go
</code></pre></div><p>其中，<em>pkg/apis/crddemo/v1</em> 下面的 <em>zz_generated.deepcopy.go</em> 文件，就是自动生成的 DeepCopy 代码文件。下面的三个包（clientset、informers、 listers），都是 Kubernetes 为 Mydemo 类型生成的client库，这些库会在后面编写自定义控制器的时候用到。</p>
<p>自定义控制器代码编写</p>
<p>k8s的声明式 API并不像“命令式 API”那样有着明显的执行逻辑。这就使得基于声明式 API 的业务功能实现，往往需要通过控制器模式来“监视”API 对象的变化，然后以此来决定实际要执行的具体工作。</p>
<p><em>main.go</em></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>


<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;flag&#34;</span>
    <span class="s">&#34;os&#34;</span>
    <span class="s">&#34;os/signal&#34;</span>
    <span class="s">&#34;syscall&#34;</span>
    <span class="s">&#34;time&#34;</span>
    <span class="s">&#34;github.com/golang/glog&#34;</span>
    <span class="s">&#34;k8s.io/client-go/kubernetes&#34;</span>
    <span class="s">&#34;k8s.io/client-go/tools/clientcmd&#34;</span>
    <span class="nx">clientset</span> <span class="s">&#34;github.com/domac/crddemo/pkg/client/clientset/versioned&#34;</span>
    <span class="nx">informers</span> <span class="s">&#34;github.com/domac/crddemo/pkg/client/informers/externalversions&#34;</span>
<span class="p">)</span>


<span class="c1">//程序启动参数
</span><span class="c1"></span><span class="kd">var</span> <span class="p">(</span>
    <span class="nx">flagSet</span>              <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">NewFlagSet</span><span class="p">(</span><span class="s">&#34;crddemo&#34;</span><span class="p">,</span> <span class="nx">flag</span><span class="p">.</span><span class="nx">ExitOnError</span><span class="p">)</span>
    <span class="nx">master</span>               <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;master&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;The address of the Kubernetes API server. Overrides any value in kubeconfig. Only required if out-of-cluster.&#34;</span><span class="p">)</span>
    <span class="nx">kubeconfig</span>           <span class="p">=</span> <span class="nx">flag</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="s">&#34;kubeconfig&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Path to a kubeconfig. Only required if out-of-cluster.&#34;</span><span class="p">)</span>
    <span class="nx">onlyOneSignalHandler</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>
    <span class="nx">shutdownSignals</span>      <span class="p">=</span> <span class="p">[</span><span class="p">]</span><span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">{</span><span class="nx">os</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">}</span>
<span class="p">)</span>


<span class="c1">//设置信号处理
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">setupSignalHandler</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">close</span><span class="p">(</span><span class="nx">onlyOneSignalHandler</span><span class="p">)</span>


    <span class="nx">stop</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">shutdownSignals</span><span class="o">...</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">&lt;-</span><span class="nx">c</span>
        <span class="nb">close</span><span class="p">(</span><span class="nx">stop</span><span class="p">)</span>
        <span class="o">&lt;-</span><span class="nx">c</span>
        <span class="nx">os</span><span class="p">.</span><span class="nf">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">}</span><span class="p">(</span><span class="p">)</span>


    <span class="k">return</span> <span class="nx">stop</span>
<span class="p">}</span>


<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="p">)</span>

    <span class="c1">//设置一个信号处理，应用于优雅关闭
</span><span class="c1"></span>    <span class="nx">stopCh</span> <span class="o">:=</span> <span class="nf">setupSignalHandler</span><span class="p">(</span><span class="p">)</span>


    <span class="nx">cfg</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientcmd</span><span class="p">.</span><span class="nf">BuildConfigFromFlags</span><span class="p">(</span><span class="o">*</span><span class="nx">master</span><span class="p">,</span> <span class="o">*</span><span class="nx">kubeconfig</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">glog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error building kubeconfig: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
    <span class="p">}</span>


    <span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">glog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error building kubernetes clientset: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
    <span class="p">}</span>


    <span class="nx">mydemoClient</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientset</span><span class="p">.</span><span class="nf">NewForConfig</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">glog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error building example clientset: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
    <span class="p">}</span>


    <span class="c1">//informerFactory工厂类， 这里注入我们通过代码生成的client
</span><span class="c1"></span>    <span class="c1">//clent主要用于和API Server 进行通信，实现ListAndWatch
</span><span class="c1"></span>    <span class="nx">mydemoInformerFactory</span> <span class="o">:=</span> <span class="nx">informers</span><span class="p">.</span><span class="nf">NewSharedInformerFactory</span><span class="p">(</span><span class="nx">mydemoClient</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span>

    <span class="c1">//生成一个crddemo组的Mydemo对象传递给自定义控制器
</span><span class="c1"></span>    <span class="nx">controller</span> <span class="o">:=</span> <span class="nf">NewController</span><span class="p">(</span><span class="nx">kubeClient</span><span class="p">,</span> <span class="nx">mydemoClient</span><span class="p">,</span>
        <span class="nf">mydemoInformerFactory</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">V1</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Mydemos</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>


    <span class="k">go</span> <span class="nf">mydemoInformerFactory</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">)</span>


    <span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">glog</span><span class="p">.</span><span class="nf">Fatalf</span><span class="p">(</span><span class="s">&#34;Error running controller: %s&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>接下来，我们来看跟业务最紧密的控制器Controller的编写</p>
<p><em>controller.go</em> 部分重要代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="err">…</span> <span class="err">…</span> 

<span class="kd">func</span> <span class="nf">NewController</span><span class="p">(</span>
    <span class="nx">kubeclientset</span> <span class="nx">kubernetes</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span>
    <span class="nx">mydemoslientset</span> <span class="nx">clientset</span><span class="p">.</span><span class="nx">Interface</span><span class="p">,</span>
    <span class="nx">mydemoInformer</span> <span class="nx">informers</span><span class="p">.</span><span class="nx">MydemoInformer</span><span class="p">)</span> <span class="o">*</span><span class="nx">Controller</span> <span class="p">{</span>


    <span class="c1">// Create event broadcaster
</span><span class="c1"></span>    <span class="c1">// Add sample-controller types to the default Kubernetes Scheme so Events can be
</span><span class="c1"></span>    <span class="c1">// logged for sample-controller types.
</span><span class="c1"></span>    <span class="nx">utilruntime</span><span class="p">.</span><span class="nf">Must</span><span class="p">(</span><span class="nx">mydemoscheme</span><span class="p">.</span><span class="nf">AddToScheme</span><span class="p">(</span><span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span><span class="p">)</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Creating event broadcaster&#34;</span><span class="p">)</span>
    <span class="nx">eventBroadcaster</span> <span class="o">:=</span> <span class="nx">record</span><span class="p">.</span><span class="nf">NewBroadcaster</span><span class="p">(</span><span class="p">)</span>
    <span class="nx">eventBroadcaster</span><span class="p">.</span><span class="nf">StartLogging</span><span class="p">(</span><span class="nx">glog</span><span class="p">.</span><span class="nx">Infof</span><span class="p">)</span>
    <span class="nx">eventBroadcaster</span><span class="p">.</span><span class="nf">StartRecordingToSink</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">typedcorev1</span><span class="p">.</span><span class="nx">EventSinkImpl</span><span class="p">{</span><span class="nx">Interface</span><span class="p">:</span> <span class="nx">kubeclientset</span><span class="p">.</span><span class="nf">CoreV1</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">Events</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span><span class="p">}</span><span class="p">)</span>
    <span class="nx">recorder</span> <span class="o">:=</span> <span class="nx">eventBroadcaster</span><span class="p">.</span><span class="nf">NewRecorder</span><span class="p">(</span><span class="nx">scheme</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">,</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">EventSource</span><span class="p">{</span><span class="nx">Component</span><span class="p">:</span> <span class="nx">controllerAgentName</span><span class="p">}</span><span class="p">)</span>


    <span class="c1">//使用client 和前面创建的 Informer，初始化了自定义控制器
</span><span class="c1"></span>    <span class="nx">controller</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Controller</span><span class="p">{</span>
        <span class="nx">kubeclientset</span><span class="p">:</span>   <span class="nx">kubeclientset</span><span class="p">,</span>
        <span class="nx">mydemoslientset</span><span class="p">:</span> <span class="nx">mydemoslientset</span><span class="p">,</span>
        <span class="nx">demoInformer</span><span class="p">:</span>    <span class="nx">mydemoInformer</span><span class="p">.</span><span class="nf">Lister</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
        <span class="nx">mydemosSynced</span><span class="p">:</span>   <span class="nx">mydemoInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nx">HasSynced</span><span class="p">,</span>
        <span class="nx">workqueue</span><span class="p">:</span>       <span class="nx">workqueue</span><span class="p">.</span><span class="nf">NewNamedRateLimitingQueue</span><span class="p">(</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">DefaultControllerRateLimiter</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="s">&#34;Mydemos”), //WorkQueue的实现，负责同步 Informer 和控制循环之间的数据
</span><span class="s">        recorder:        recorder,
</span><span class="s">    }
</span><span class="s">
</span><span class="s">
</span><span class="s">    glog.Info(&#34;</span><span class="nx">Setting</span> <span class="nx">up</span> <span class="nx">mydemo</span> <span class="nx">event</span> <span class="nx">handlers</span><span class="err">”</span><span class="p">)</span>

    <span class="c1">//mydemoInformer 注册了三个 Handler（AddFunc、UpdateFunc 和 DeleteFunc）
</span><span class="c1"></span>    <span class="c1">// 分别对应 API 对象的“添加”“更新”和“删除”事件。而具体的处理操作，都是将该事件对应的 API 对象加入到工作队列中
</span><span class="c1"></span>    <span class="nx">mydemoInformer</span><span class="p">.</span><span class="nf">Informer</span><span class="p">(</span><span class="p">)</span><span class="p">.</span><span class="nf">AddEventHandler</span><span class="p">(</span><span class="nx">cache</span><span class="p">.</span><span class="nx">ResourceEventHandlerFuncs</span><span class="p">{</span>
        <span class="nx">AddFunc</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">enqueueMydemo</span><span class="p">,</span>
        <span class="nx">UpdateFunc</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span> <span class="nx">new</span> <span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">oldMydemo</span> <span class="o">:=</span> <span class="nx">old</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">samplecrdv1</span><span class="p">.</span><span class="nx">Mydemo</span><span class="p">)</span>
            <span class="nx">newMydemo</span> <span class="o">:=</span> <span class="nx">new</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">samplecrdv1</span><span class="p">.</span><span class="nx">Mydemo</span><span class="p">)</span>
            <span class="k">if</span> <span class="nx">oldMydemo</span><span class="p">.</span><span class="nx">ResourceVersion</span> <span class="o">==</span> <span class="nx">newMydemo</span><span class="p">.</span><span class="nx">ResourceVersion</span> <span class="p">{</span>
                <span class="k">return</span>
            <span class="p">}</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nf">enqueueMydemo</span><span class="p">(</span><span class="nx">new</span><span class="p">)</span>
        <span class="p">}</span><span class="p">,</span>
        <span class="nx">DeleteFunc</span><span class="p">:</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">enqueueMydemoForDelete</span><span class="p">,</span>
    <span class="p">}</span><span class="p">)</span>


    <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>

<span class="err">…</span> <span class="err">…</span> 
</code></pre></div><p>通过上面Controller的代码实现，我们基本实现了控制器ListAndWatch的事件注册逻辑：通过 APIServer 的 LIST API获取所有最新版本的 API 对象；然后，再通过 WATCH-API 来监听所有这些API对象的变化。通过监听到的事件变化，Informer 就可以实时地更新本地缓存，并且调用这些事件对应的 EventHandler了</p>
<p>下面，我们再来看原理图中的Control Loop的部分</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">Run</span><span class="p">(</span><span class="nx">threadiness</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">stopCh</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="nx">runtime</span><span class="p">.</span><span class="nf">HandleCrash</span><span class="p">(</span><span class="p">)</span>
    <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">ShutDown</span><span class="p">(</span><span class="p">)</span>


    <span class="c1">// 记录开始日志
</span><span class="c1"></span>    <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting Mydemo control loop&#34;</span><span class="p">)</span>
  
    <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Waiting for informer caches to sync&#34;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">WaitForCacheSync</span><span class="p">(</span><span class="nx">stopCh</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">mydemosSynced</span><span class="p">)</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to wait for caches to sync&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Starting workers&#34;</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nx">threadiness</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">{</span>
        <span class="k">go</span> <span class="nx">wait</span><span class="p">.</span><span class="nf">Until</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">runWorker</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span> <span class="nx">stopCh</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Started workers&#34;</span><span class="p">)</span>
    <span class="o">&lt;-</span><span class="nx">stopCh</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;Shutting down workers&#34;</span><span class="p">)</span>


    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>可以看到，启动控制循环的逻辑非常简单，就是同步+循环监听任务。而这个循环监听任务就是我们真正的业务实现部分了</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go">
<span class="c1">//runWorker是一个不断运行的方法，并且一直会调用 c.processNextWorkItem 从workqueue读取和读取消息
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">runWorker</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">c</span><span class="p">.</span><span class="nf">processNextWorkItem</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">//从workqueue读取和读取消息
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">processNextWorkItem</span><span class="p">(</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">obj</span><span class="p">,</span> <span class="nx">shutdown</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">shutdown</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">obj</span> <span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
        <span class="k">defer</span> <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">key</span> <span class="kt">string</span>
        <span class="kd">var</span> <span class="nx">ok</span> <span class="kt">bool</span>
        <span class="k">if</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">ok</span> <span class="p">=</span> <span class="nx">obj</span><span class="p">.</span><span class="p">(</span><span class="kt">string</span><span class="p">)</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Forget</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
            <span class="nx">runtime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;expected string in workqueue but got %#v&#34;</span><span class="p">,</span> <span class="nx">obj</span><span class="p">)</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">syncHandler</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;error syncing &#39;%s&#39;: %s&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">workqueue</span><span class="p">.</span><span class="nf">Forget</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
        <span class="nx">glog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;Successfully synced &#39;%s&#39;&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">runtime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">//尝试从 Informer 维护的缓存中拿到了它所对应的 Mydemo 对象
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">Controller</span><span class="p">)</span> <span class="nf">syncHandler</span><span class="p">(</span><span class="nx">key</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">cache</span><span class="p">.</span><span class="nf">SplitMetaNamespaceKey</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">runtime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;invalid resource key: %s&#34;</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">nil</span>
    <span class="p">}</span>

    <span class="nx">mydemo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nx">demoInformer</span><span class="p">.</span><span class="nf">Mydemos</span><span class="p">(</span><span class="nx">namespace</span><span class="p">)</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
 
    <span class="c1">//从缓存中拿不到这个对象,那就意味着这个 Mydemo 对象的 Key 是通过前面的“删除”事件添加进工作队列的。
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">if</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">IsNotFound</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">//对应的 Mydemo 对象已经被删除了
</span><span class="c1"></span>            <span class="nx">glog</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;DemoCRD: %s/%s does not exist in local cache, will delete it from Mydemo ...&#34;</span><span class="p">,</span>
                <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
            <span class="nx">glog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;[DemoCRD] Deleting mydemo: %s/%s ...&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">nil</span>
        <span class="p">}</span>
        <span class="nx">runtime</span><span class="p">.</span><span class="nf">HandleError</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to list mydemo by: %s/%s&#34;</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">,</span> <span class="nx">name</span><span class="p">)</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">glog</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;[DemoCRD] Try to process mydemo: %#v ...&#34;</span><span class="p">,</span> <span class="nx">mydemo</span><span class="p">)</span>
    <span class="nx">c</span><span class="p">.</span><span class="nx">recorder</span><span class="p">.</span><span class="nf">Event</span><span class="p">(</span><span class="nx">mydemo</span><span class="p">,</span> <span class="nx">corev1</span><span class="p">.</span><span class="nx">EventTypeNormal</span><span class="p">,</span> <span class="nx">SuccessSynced</span><span class="p">,</span> <span class="nx">MessageResourceSynced</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>代码中的 <code>demoInformer</code>，从namespace中通过key获取Mydemo对象这个操作，其实就是在访问本地缓存的索引，实际上，在 Kubernetes 的源码中，你会经常看到控制器从各种 Lister 里获取对象，比如：podLister、nodeLister 等等，它们使用的都是 Informer 和缓存机制。</p>
<p>而如果控制循环从缓存中拿不到这个对象（demoInformer 返回了 IsNotFound 错误），那就意味着这个 Mydemo 对象的 Key 是通过前面的“删除”事件添加进工作队列的。所以，尽管队列里有这个 Key，但是对应的 Mydemo 对象已经被删除了。而如果能够获取到对应的 Mydemo 对象，就可以执行控制器模式里的对比“期望状态（用户通过 YAML 文件提交到 APIServer 里的信息）”和“实际状态（我们的控制循环需要通过查询实际的Mydemo资源情况” 的功能逻辑了。不过在本例子中，就不做过多的业务假设了。</p>
<p>至此，一个完整的自定义 API 对象和它所对应的自定义控制器，就编写完毕了。</p>
<h3 id="部署测试">部署测试</h3>
<p>代码编码后，我们准备开始代码的发布，可以使用提供 <em>Makefile</em> 进行编译</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$ make

... …

gofmt -w .
go <span class="nb">test</span> -v . 
?       github.com/domac/crddemo        <span class="o">[</span>no <span class="nb">test</span> files<span class="o">]</span>
mkdir -p releases
<span class="nv">GOOS</span><span class="o">=</span>linux <span class="nv">GOARCH</span><span class="o">=</span>amd64 go build -mod<span class="o">=</span>vendor -ldflags <span class="s2">&#34;-s -w&#34;</span> -v -o releases/crddemo *.go
github.com/golang/groupcache/lru
k8s.io/apimachinery/third_party/forked/golang/json
k8s.io/apimachinery/pkg/util/mergepatch
k8s.io/kube-openapi/pkg/util/proto
k8s.io/client-go/tools/record/util
k8s.io/apimachinery/pkg/util/strategicpatch
k8s.io/client-go/tools/record
command-line-arguments
go clean -i

... ...
</code></pre></div><p>编译完成后，会生成 <em>crddemo</em> 的二进制文件，我们要做把crddemo放到kubernetes集群中，或者本地也行，只要能访问到 <code>apiserver</code> 和具备<code>kubeconfig</code></p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  ./crddemo --kubeconfig<span class="o">=</span>/data/svr/projects/kubernetes/config/kubectl.kubeconfig --master<span class="o">=</span>http://127.0.0.1:8080  -alsologtostderr<span class="o">=</span><span class="nb">true</span> 

I0308 12:23:18.494507   <span class="m">27426</span> controller.go:79<span class="o">]</span> Setting up mydemo event handlers
I0308 12:23:18.494829   <span class="m">27426</span> controller.go:105<span class="o">]</span> Starting Mydemo control loop
I0308 12:23:18.494840   <span class="m">27426</span> controller.go:108<span class="o">]</span> Waiting <span class="k">for</span> informer caches to sync
E0308 12:23:18.496902   <span class="m">27426</span> reflector.go:178<span class="o">]</span> github.com/domac/crddemo/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1.Mydemo: the server could not find the requested resource <span class="o">(</span>get mydemos.crddemo.k8s.io<span class="o">)</span>
E0308 12:23:18.497477   <span class="m">27426</span> reflector.go:178<span class="o">]</span> github.com/domac/crddemo/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1.Mydemo: the server could not find the requested resource <span class="o">(</span>get mydemos.crddemo.k8s.io<span class="o">)</span>
E0308 12:23:21.604508   <span class="m">27426</span> reflector.go:178<span class="o">]</span> github.com/domac/crddemo/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1.Mydemo: the server could not find the requested resource <span class="o">(</span>get mydemos.crddemo.k8s.io<span class="o">)</span>
E0308 12:23:26.932293   <span class="m">27426</span> reflector.go:178<span class="o">]</span> github.com/domac/crddemo/pkg/client/informers/externalversions/factory.go:117: Failed to list *v1.Mydemo: the server could not find the requested resource <span class="o">(</span>get mydemos.crddemo.k8s.io<span class="o">)</span>


... ...
</code></pre></div><p>可以看到，程序运行的时候，一开始会报错。这是因为，此时 Mydemo 对象的 CRD 还没有被创建出来，所以 Informer 去 APIServer 里获取 Mydemos 对象时，并不能找到 Mydemo 这个 API 资源类型的定义</p>
<p>接下来，我们执行我们自定义资源的定义文件：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  kubectl apply -f crd/mydemo.yaml 
customresourcedefinition.apiextensions.k8s.io/mydemos.crddemo.k8s.io created
</code></pre></div><p>此时，观察crddemo的日志输出，可以看到Controller的日志恢复了正常，控制循环启动成功</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">I0308 12:30:29.956263   <span class="m">28282</span> controller.go:113<span class="o">]</span> Starting workers
I0308 12:30:29.956307   <span class="m">28282</span> controller.go:118<span class="o">]</span> Started workers
</code></pre></div><p>然后，我们可以对我们的Mydemo对象进行增删改查操作了。</p>
<p>提交我们的自定义资源对象</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  kubectl apply -f example-mydemo.yaml 
mydemo.crddemo.k8s.io/example-mydemo created
</code></pre></div><p>创建成功够，看k8s集群是否成功存储起来</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  kubectl get Mydemo                   
NAME             AGE
example-mydemo   2s
</code></pre></div><p>这时候，查看一下控制器的输出：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">I0308 12:31:24.983663   <span class="m">28282</span> controller.go:216<span class="o">]</span> <span class="o">[</span>DemoCRD<span class="o">]</span> Try to process mydemo: <span class="p">&amp;</span>v1.Mydemo<span class="o">{</span>TypeMeta:v1.TypeMeta<span class="o">{</span>Kind:<span class="s2">&#34;&#34;</span>, APIVersion:<span class="s2">&#34;&#34;</span><span class="o">}</span>, ObjectMeta:v1.ObjectMeta<span class="o">{</span>Name:<span class="s2">&#34;example-mydemo&#34;</span>, GenerateName:<span class="s2">&#34;&#34;</span>, Namespace:<span class="s2">&#34;default&#34;</span>, SelfLink:<span class="s2">&#34;/apis/crddemo.k8s.io/v1/namespaces/default/mydemos/example-mydemo&#34;</span>, UID:<span class="s2">&#34;8a6d17f7-17f3-4a1d-8250-bb092678ae7e&#34;</span>, ResourceVersion:<span class="s2">&#34;10818363&#34;</span>, Generation:1, CreationTimestamp:v1.Time<span class="o">{</span>Time:time.Time<span class="o">{</span>wall:0x0, ext:63719238684, loc:<span class="o">(</span>*time.Location<span class="o">)</span><span class="o">(</span>0x1e566c0<span class="o">)</span><span class="o">}</span><span class="o">}</span>, DeletionTimestamp:<span class="o">(</span>*v1.Time<span class="o">)</span><span class="o">(</span>nil<span class="o">)</span>, DeletionGracePeriodSeconds:<span class="o">(</span>*int64<span class="o">)</span><span class="o">(</span>nil<span class="o">)</span>, Labels:map<span class="o">[</span>string<span class="o">]</span>string<span class="o">(</span>nil<span class="o">)</span>, Annotations:map<span class="o">[</span>string<span class="o">]</span>string<span class="o">{</span><span class="s2">&#34;kubectl.kubernetes.io/last-applied-configuration&#34;</span>:<span class="s2">&#34;{\&#34;apiVersion\&#34;:\&#34;crddemo.k8s.io/v1\&#34;,\&#34;kind\&#34;:\&#34;Mydemo\&#34;,\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{},\&#34;name\&#34;:\&#34;example-mydemo\&#34;,\&#34;namespace\&#34;:\&#34;default\&#34;},\&#34;spec\&#34;:{\&#34;ip\&#34;:\&#34;127.0.0.1\&#34;,\&#34;port\&#34;:8080}}\n&#34;</span><span class="o">}</span>, OwnerReferences:<span class="o">[</span><span class="o">]</span>v1.OwnerReference<span class="o">(</span>nil<span class="o">)</span>, Finalizers:<span class="o">[</span><span class="o">]</span>string<span class="o">(</span>nil<span class="o">)</span>, ClusterName:<span class="s2">&#34;&#34;</span>, ManagedFields:<span class="o">[</span><span class="o">]</span>v1.ManagedFieldsEntry<span class="o">(</span>nil<span class="o">)</span><span class="o">}</span>, Spec:v1.MydemoSpec<span class="o">{</span>Ip:<span class="s2">&#34;127.0.0.1&#34;</span>, Port:8080<span class="o">}</span><span class="o">}</span> …

I0308 12:31:24.983844   <span class="m">28282</span> controller.go:174<span class="o">]</span> Successfully synced <span class="s1">&#39;default/example-mydemo’
</span><span class="s1">
</span><span class="s1">I0308 12:31:24.983893   28282 event.go:278] Event(v1.ObjectReference{Kind:&#34;Mydemo&#34;, Namespace:&#34;default&#34;, Name:&#34;example-mydemo&#34;, UID:&#34;8a6d17f7-17f3-4a1d-8250-bb092678ae7e&#34;, APIVersion:&#34;crddemo.k8s.io/v1&#34;, ResourceVersion:&#34;10818363&#34;, FieldPath:&#34;&#34;}): type: &#39;</span>Normal<span class="s1">&#39; reason: &#39;</span>Synced<span class="err">&#39;</span> Mydemo synced successfully
</code></pre></div><p>可以看到，我们上面创建 example-mydemo.yaml 的操作，触发了 EventHandler 的添加事件，从而被放进了工作队列。紧接着，控制循环就从队列里拿到了这个对象，并且打印出了正在处理这个 Mydemo 对象的日志。</p>
<p>我们这时候，尝试修改资源，对对应的port属性进行修改</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">apiVersion<span class="p">:</span><span class="w"> </span>crddemo.k8s.io/v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Mydemo<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>example-mydemo<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>ip<span class="p">:</span><span class="w"> </span><span class="s2">&#34;127.0.0.1&#34;</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">9090</span><span class="w">
</span></code></pre></div><p>手动执行修改:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  kubectl apply -f example-mydemo.yaml
</code></pre></div><p>此时，crddemo新增出来的日志如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">I0308 12:32:05.663044   <span class="m">28282</span> controller.go:216<span class="o">]</span> <span class="o">[</span>DemoCRD<span class="o">]</span> Try to process mydemo: <span class="p">&amp;</span>v1.Mydemo<span class="o">{</span>TypeMeta:v1.TypeMeta<span class="o">{</span>Kind:<span class="s2">&#34;&#34;</span>, APIVersion:<span class="s2">&#34;&#34;</span><span class="o">}</span>, ObjectMeta:v1.ObjectMeta<span class="o">{</span>Name:<span class="s2">&#34;example-mydemo&#34;</span>, GenerateName:<span class="s2">&#34;&#34;</span>, Namespace:<span class="s2">&#34;default&#34;</span>, SelfLink:<span class="s2">&#34;/apis/crddemo.k8s.io/v1/namespaces/default/mydemos/example-mydemo&#34;</span>, UID:<span class="s2">&#34;8a6d17f7-17f3-4a1d-8250-bb092678ae7e&#34;</span>, ResourceVersion:<span class="s2">&#34;10818457&#34;</span>, Generation:2, CreationTimestamp:v1.Time<span class="o">{</span>Time:time.Time<span class="o">{</span>wall:0x0, ext:63719238684, loc:<span class="o">(</span>*time.Location<span class="o">)</span><span class="o">(</span>0x1e566c0<span class="o">)</span><span class="o">}</span><span class="o">}</span>, DeletionTimestamp:<span class="o">(</span>*v1.Time<span class="o">)</span><span class="o">(</span>nil<span class="o">)</span>, DeletionGracePeriodSeconds:<span class="o">(</span>*int64<span class="o">)</span><span class="o">(</span>nil<span class="o">)</span>, Labels:map<span class="o">[</span>string<span class="o">]</span>string<span class="o">(</span>nil<span class="o">)</span>, Annotations:map<span class="o">[</span>string<span class="o">]</span>string<span class="o">{</span><span class="s2">&#34;kubectl.kubernetes.io/last-applied-configuration&#34;</span>:<span class="s2">&#34;{\&#34;apiVersion\&#34;:\&#34;crddemo.k8s.io/v1\&#34;,\&#34;kind\&#34;:\&#34;Mydemo\&#34;,\&#34;metadata\&#34;:{\&#34;annotations\&#34;:{},\&#34;name\&#34;:\&#34;example-mydemo\&#34;,\&#34;namespace\&#34;:\&#34;default\&#34;},\&#34;spec\&#34;:{\&#34;ip\&#34;:\&#34;127.0.0.1\&#34;,\&#34;port\&#34;:9080}}\n&#34;</span><span class="o">}</span>, OwnerReferences:<span class="o">[</span><span class="o">]</span>v1.OwnerReference<span class="o">(</span>nil<span class="o">)</span>, Finalizers:<span class="o">[</span><span class="o">]</span>string<span class="o">(</span>nil<span class="o">)</span>, ClusterName:<span class="s2">&#34;&#34;</span>, ManagedFields:<span class="o">[</span><span class="o">]</span>v1.ManagedFieldsEntry<span class="o">(</span>nil<span class="o">)</span><span class="o">}</span>, Spec:v1.MydemoSpec<span class="o">{</span>Ip:<span class="s2">&#34;127.0.0.1&#34;</span>, Port:9080<span class="o">}</span><span class="o">}</span> …

I0308 12:32:05.663179   <span class="m">28282</span> controller.go:174<span class="o">]</span> Successfully synced <span class="s1">&#39;default/example-mydemo’
</span><span class="s1">
</span><span class="s1">I0308 12:32:05.663208   28282 event.go:278] Event(v1.ObjectReference{Kind:&#34;Mydemo&#34;, Namespace:&#34;default&#34;, Name:&#34;example-mydemo&#34;, UID:&#34;8a6d17f7-17f3-4a1d-8250-bb092678ae7e&#34;, APIVersion:&#34;crddemo.k8s.io/v1&#34;, ResourceVersion:&#34;10818457&#34;, FieldPath:&#34;&#34;}): type: &#39;</span>Normal<span class="s1">&#39; reason: &#39;</span>Synced<span class="err">&#39;</span> Mydemo synced successfully
</code></pre></div><p>可以看到，这一次，Informer 注册的更新事件被触发，更新后的Mydemo对象的 Key 被添加到了工作队列之中。</p>
<p>所以，接下来控制循环从工作队列里拿到的Mydemo对象，与前一个对象是不同的：它的<code>ResourceVersion</code>的值从 <code>10818363</code> 变成了 <code>10818457</code> ；而 Spec 里的Port字段，则变成了 <code>9080</code>。最后，我再把这个对象删除掉：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  kubectl delete -f example-mydemo.yaml 
mydemo.crddemo.k8s.io <span class="s2">&#34;example-mydemo&#34;</span> deleted
</code></pre></div><p>这一次，在控制器的输出里，我们就可以看到，Informer 注册的“删除”事件被触发,输出如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">
<span class="m">0308</span> 12:33:08.494755   <span class="m">28282</span> controller.go:203<span class="o">]</span> DemoCRD: default/example-mydemo does not exist in <span class="nb">local</span> cache, will delete it from Mydemo …

I0308 12:33:08.495793   <span class="m">28282</span> controller.go:206<span class="o">]</span> <span class="o">[</span>DemoCRD<span class="o">]</span> Deleting mydemo: default/example-mydemo …

I0308 12:33:08.495808   <span class="m">28282</span> controller.go:174<span class="o">]</span> Successfully synced <span class="s1">&#39;default/example-mydemo&#39;</span>
</code></pre></div><p>然后，k8s集群的资源也被清除了：</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">$  kubectl get Mydemo                    
No resources found in default namespace.
</code></pre></div><p>以上就是使用自定义控制器的基本开发流程</p></div>
                    <div class="post_footer">
                        
                        <div class="meta">
                            <div class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                    <a href="https://domac.github.io/tags/kubernetes/">kubernetes</a>
                                    
                                    <a href="https://domac.github.io/tags/go/">go</a>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                
                <div class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    <a id="back_to_top" href="#" class="back_to_top"><i class="ri-arrow-up-s-line"></i></a>
    <footer class="footer">
    

    <div class="footer_slogan">
        <span>用自律诠释坚持</span>
    </div>
</footer>
    <script src="https://domac.github.io/js/jquery-3.5.1.min.js"></script>
<link href="https://domac.github.io/css/fancybox.min.css" rel="stylesheet">
<script src="https://domac.github.io/js/fancybox.min.js"></script>
<script src="https://domac.github.io/js/zozo.js"></script>


<script type="text/javascript" async
    src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\[\[', '\]\]']],
                processEscapes: true,
                processEnvironments: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
                TeX: {
                    equationNumbers: { autoNumber: "AMS" },
                    extensions: ["AMSmath.js", "AMSsymbols.js"]
                }
            }
        });

        MathJax.Hub.Queue(function () {
            
            
            
            var all = MathJax.Hub.getAllJax(), i;
            for (i = 0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
            }
        });
    </script>

<style>
    code.has-jax {
        font: inherit;
        font-size: 100%;
        background: inherit;
        border: inherit;
        color: #515151;
    }
</style>



</body>

</html>